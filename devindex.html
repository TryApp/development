<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>AppBox - Distribution of iOS app with your Dropbox account.</title>
	<STYLE type="text/css">
		body {
			min-width: 100%;
			min-height: 100%;
			background:white !important;
		}
		
		html {
			width: 100%;
			height: 95%;
		}
		
		div.mainDiv {
			width: 100%;
			height: 95%;
		}

		div.loadDiv{

		}
		
		div.headerDiv{
			height: 24%;
		}
		
		div.contentDiv{
			height: 70%;
		}
		
		div.footerDiv{
			height: 5%;
		}
		
		div.buildDiv{
			width: 100%;
			height: 100%;
		}
		
		p.title {
			color: #333;
			font-size: 100px;
			font-weight:100;
			padding: 0px;
			text-align: center;
		}
		
		p.subtitle {
			color: #666;
			font-size: 60px;
			text-align: center;
			padding: 0px;
			width: 100%;
			margin: -100px 0px 0px 0px;
		}

		p.loading {
			color: #666;
			font-size: 60px;
			text-align: center;
			padding: 0px;
			width: 100%;
			margin: -180px 0px 0px 0px;
		}

		p.version {
			color: #666;
			font-size: 45px;
			text-align: center;
			padding: 0px;
			width: 100%;
			margin: 0px 0px 0px 0px;
		}
		
		p.footer {
			color: #666;
			font-size: 80px;
			text-align: center;
			margin: 0 auto;
			position: absolute;
		}
		
		p.miniSubtitle {
			color: #666;
			font-size: 60px;
			padding: 15px;
			margin: 0px;
		}
		
		button.appBoxButton {
			color: #666;
			border: 0px;
			background: white;
			font-size: 80px;
			text-align: center;
			margin: 0 auto;
		}

		button.installButton {
			border: 2px solid green;
			border-radius: 15px;
			background: white;
    			color: green;
    			padding: 15px 32px;
    			text-align: center;
    			text-decoration: none;
    			display: inline-block;
    			font-size: 80px;
    			margin: 50px 0px 10px 0px;
		}
		
		button.allBuildButton {
			border: 1px solid #666;
			border-radius: 5px;
			background: white;
    			color: #666;
    			padding: 10px 20px 10px 20px;
    			font-size: 50px;
    			margin: 5px;
		}
		
		button.closeAllBuildButton{
			margin: -90px 5px 5px 5px;
			right: 15px; 
			position: absolute;
		}
		
		.defaultTable{
			border-collapse:collapse;
			width:100%
		}
		
		.defaultTable td,.defaultTable th{
			border:1px solid #ddd;
			text-align:left;
			padding:5px;
			font-size:30px;
		}
		
		.defaultTable tr:nth-child(even){
			background-color:#f2f2f2
		}
		
		.defaultTable th{
			padding-top:8px;
			padding-bottom:8px;
			background-color:#4285f4;
			color:#fff
		}
		
	</STYLE>
</head>
<body>
	<div id="loaderDiv" class="mainDiv">
		<center>
			<img style="margin:200px;" src="loading.gif" alt="loading..." height="125" width="125">
			<p id="loadingTitle" class="loading">loading...</p>
		</center>
	</div>
	<div id="mainDiv" class="mainDiv" hidden>
		<div id="headerDiv" class="headerDiv">
		    	<p id="appTitle" class="title">Wait..."</p>
			<p id="appIdentifier" class="subtitle">Wait...</p>
			<p id="appVersion" class="version">Wait...</p>
		</div>
    		<div id="contentDiv" class="contentDiv">
			<center>
				<button id="installButton" onclick="installApp()" class="installButton">Install</button>
				<br />
				<button id="showAllBuildButton" onclick="showAllBuilds()" class="installButton allBuildButton">Install Previous Builds</button>
			</center>
    		</div>
		<div id="footerDiv" class="footerDiv">
			<center>
				<button class="appBoxButton" onclick="appPage()">powered by AppBox</button>
			</center>
		</div>
	</div>
	<div id="allBuildsDiv" class="buildDiv" hidden>
		<p class="miniSubtitle">All Builds</p>
		<button id="hideAllBuildsButton" onClick="showAllBuilds()" class="allBuildButton closeAllBuildButton"> X </button>
		<hr/>
		<table id="allBuildTable">
		</table>
	</div>
	<div id="errorDiv" class="mainDiv" hidden>
		<div class="headerDiv">
			<p class="footer">The app you were looking for is not available anymore. It might has been deleted. Please refer to your app developer for any question.</p>
		</div>
	</div>
    <script>
	var qrStr = window.location.search;
        qrStr = qrStr.split("?url=")[1];
	var menifestLinkPath = qrStr;
	    
	function showAllBuilds(){
		document.getElementById('mainDiv').hidden = !document.getElementById('mainDiv').hidden;
		document.getElementById('allBuildsDiv').hidden = !document.getElementById('allBuildsDiv').hidden;
	}
	    
	function installApp(menifest) {
		if (menifest == null){
			menifest = menifestLinkPath;
		}
    		window.location.href = "itms-services://?action=download-manifest&url=https://dl.dropbox.com" + menifest;
		document.getElementById('loadingTitle').textContent = "Connecting...";
		document.getElementById('mainDiv').hidden = true;
		document.getElementById('loaderDiv').hidden = false;
		setTimeout(hideLoadingUI, 10000);
	}
	    
	function appPage() {
    		window.location.href = "https://iosappswirelessinstallation.codeplex.com/";
	}
	    
	function hideLoadingUI(){
		document.getElementById('mainDiv').hidden = false;				
		document.getElementById('loaderDiv').hidden = true;
	}
	    
	function showErrorUI(){
		document.getElementById('loaderDiv').hidden = true;
		document.getElementById('errorDiv').hidden = false;
	}
	    
	function trackPageName(){
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  		ga('create', 'UA-85215717-1', 'auto');
  		ga('send', 'pageview');
	}
	    
	function updatePreviousBuild(versions){
		var table = document.getElementById("allBuildTable");
		for (i=0; i<versions.length; i++){
			var version = versions[i];
			var row = table.insertRow(i);
			var cell1 = row.insertCell(0);
			var cell2 = row.insertCell(1);
			cell1.innerHTML = '<p class=\"miniSubtitle\">' + version.version + '(' + version.build  +')</p>';
			var buttonId = 'appInstall' + i;
			var menifestLink = version.manifestLink.split("dropbox.com")[1];
			cell2.innerHTML = '<button id=\"'+buttonId+'\" link=\"'+menifestLink+'\" class=\"installButton allBuildButton\">Install</button>';	
			var button = document.getElementById(buttonId);
			button.addEventListener('click', function(){
				installApp(this.getAttribute("link"));
			});
		}
	}
	    
        if (qrStr) {
		if (qrStr.indexOf('manifest.plist') != -1){
			var client = new XMLHttpRequest();
			client.timeout = 60000;
			client.onreadystatechange = function() {
				if (client.readyState == 4  && client.status == 200) {
            				try{
						menifestLinkPath = qrStr;
						var response =  client.responseText.replace(new RegExp(/[^a-zA-Z0-9.]/g),'');
						var first = response.split('stringkeytitlekeystring')[1].toString().split('string')[0];
						var appTitle = response.split('stringkeytitlekeystring')[1].toString().split('string')[0];
						var appIdentifier = response.split('keybundleidentifierkeystring')[1].toString().split('string')[0];
						var appVersion =  response.split('stringkeybundleversionkeystring')[1].toString().split('string')[0];
						document.getElementById('appTitle').textContent = appTitle;
						document.getElementById('appVersion').textContent = "ver " + appVersion;
						document.getElementById('appIdentifier').textContent = appIdentifier;
						document.getElementById('installButton').textContent = "Install Application";
            					document.getElementById('mainDiv').hidden = false;
						document.getElementById('loaderDiv').hidden = true;
						document.title = appTitle + " | AppBox";
						trackPageName();
					}
					catch (err) {
						showErrorUI();
					}
        			}else if (client.status >= 400){
					showErrorUI();
				}
			};
			client.open('GET', 'https://dl.dropboxusercontent.com' + qrStr);
			client.setRequestHeader('Content-Type', 'text/xml');
			client.overrideMimeType('text/xml')
			client.send();
		}else if (qrStr.indexOf('appinfo.json') != -1){
			var client = new XMLHttpRequest();
			client.timeout = 60000;
			client.onreadystatechange = function() {
				if (client.readyState == 4  && client.status == 200) {
            				try{
						var response =  JSON.parse(client.responseText);
						menifestLinkPath = response.latestVersion.manifestLink.split("dropbox.com")[1];
						var first = response.latestVersion.build;
						var appTitle = response.latestVersion.name;
						var appIdentifier = response.latestVersion.identifier;
						var appVersion =  response.latestVersion.version;
						document.getElementById('appTitle').textContent = appTitle;
						document.getElementById('appVersion').textContent = "ver " + appVersion;
						document.getElementById('appIdentifier').textContent = appIdentifier;
						document.getElementById('installButton').textContent = "Install Application";
            					document.getElementById('mainDiv').hidden = false;
						document.getElementById('loaderDiv').hidden = true;
						document.title = appTitle + " | AppBox";
						trackPageName();
						updatePreviousBuild(response.versions);
					}
					catch (err) {
						showErrorUI();
					}
        			}else if (client.status >= 400){
					showErrorUI();
				}
			};
			client.open('GET', 'https://dl.dropboxusercontent.com' + qrStr);
			client.setRequestHeader('Content-Type', 'text/xml');
			client.overrideMimeType('text/xml')
			client.send();
		}else{
			showErrorUI();			  
		}
	}else {
		showErrorUI();
        }
    </script>
</body>
</html>
